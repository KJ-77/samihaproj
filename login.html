<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Samiha Zeindine Coaching</title>

  <link rel="stylesheet" href="css/loginForm.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>

  <!-- HEADER -->
  <header class="dashboard-header">
    <div class="header-left">
      <span>Samiha Zeindine Coaching</span>
    </div>
    <div class="header-right">
      <select class="language-selector" id="languageSelector">
        <option value="en">EN</option>
        <option value="fr">FR</option>
        <option value="ar">AR</option>
      </select>
    </div>
  </header>

  <!-- MAIN -->
  <main class="login-page">
    <h1 class="login-title">Login</h1>

    <form id="loginForm" class="login-form">

      <div class="fields">
        <div class="field-row">
          <i class="fa fa-envelope"></i>
          <input
            id="loginEmail"
            type="email"
            placeholder="Email..."
            autocomplete="username"
            required>
        </div>

        <div class="field-row">
          <i class="fa fa-lock"></i>
          <input
            id="loginPassword"
            type="password"
            placeholder="Password..."
            autocomplete="current-password"
            required>
        </div>
      </div>

      <div id="loginError" style="color:#b71c1c;font-size:0.85rem;margin-bottom:8px;"></div>
      <div id="loginSuccess" style="color:#1b5e20;font-size:0.85rem;margin-bottom:8px;"></div>

      <div class="form-actions">
        <button type="submit" class="btn-auth btn-login" id="loginBtn">Login</button>
        <a href="register.html" class="btn-auth btn-register">Register</a>
      </div>

      <div class="forgot">
        <a href="forgot.html">FORGOT PASSWORD?</a>
      </div>
    </form>

    <div class="footer-note">
      Â© 2025 Samiha Zeindine. All rights reserved.
    </div>
  </main>
  <!-- ================================
       REQUIRED SCRIPTS (ORDER MATTERS)
  ================================ -->

  <!-- 1) Cognito SDK -->
  <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6/dist/amazon-cognito-identity.min.js"></script>

  <!-- 2) Your Cognito helpers (must define CognitoAuth) -->
  <script src="js/cognito-config.js"></script>

  <!-- 3) Your API base URL -->
  <script src="js/admin-config.js"></script>

  <!-- 4) Optional: your admin api helpers (if you want to reuse) -->
  <script src="js/admin-api.js"></script>

  <!-- ================================
       HELPERS (DB SYNC)
  ================================ -->
  <script>
    async function syncUserToDatabase(payload, fallbackEmail) {
      // Frontend-only approach: keep it simple, no JWT header to avoid CORS preflight issues.
      const id = payload.sub;
      const email = payload.email || fallbackEmail;
      const name =
        payload.name ||
        payload.given_name ||
        payload["cognito:username"] ||
        (email ? email.split("@")[0] : "User");

      // If something is missing, don't crash login
      if (!id || !email) {
        console.warn("DB sync skipped: missing id/email", { id, email });
        return;
      }

      try {
        const res = await fetch(`${ADMIN_ENV.API_BASE_URL}/users`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id, name, email })
        });

        // Some APIs return 409 for duplicate; ignore it
        if (res.status === 409) {
          console.log("User already exists in DB (409).");
          return;
        }

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          console.warn("DB sync failed:", res.status, text);
          return;
        }

        console.log("DB sync OK");
      } catch (err) {
        console.warn("DB sync exception:", err);
      }
    }
  </script>
  <!-- ================================
       LOGIN + DB SYNC LOGIC
  ================================ -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("loginForm");
      const emailEl = document.getElementById("loginEmail");
      const passEl = document.getElementById("loginPassword");
      const errorBox = document.getElementById("loginError");
      const successBox = document.getElementById("loginSuccess");
      const loginBtn = document.getElementById("loginBtn");

      if (!form) return;

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        errorBox.textContent = "";
        successBox.textContent = "";

        const email = emailEl.value.trim();
        const password = passEl.value;

        if (!email || !password) {
          errorBox.textContent = "Please enter your email and password.";
          return;
        }

        loginBtn.disabled = true;
        loginBtn.style.opacity = "0.8";

        try {
          // 1) LOGIN WITH COGNITO
          await CognitoAuth.cognitoSignIn(email, password);

          // 2) GET SESSION + TOKEN PAYLOAD
          const sessionInfo = await CognitoAuth.getCurrentSession();
          if (!sessionInfo || !sessionInfo.session || !sessionInfo.session.isValid()) {
            throw new Error("Login succeeded but session is not valid.");
          }

          const payload = sessionInfo.session.getIdToken().payload;

          // 3) SYNC USER TO DATABASE (Option A)
          //    Do NOT block login if it fails
          await syncUserToDatabase(payload, email);

          // 4) REDIRECT BASED ON ROLE
          const groups = payload["cognito:groups"] || [];
          successBox.textContent = "Login successful. Redirecting...";

          window.location.href = groups.includes("Admin")
            ? "admin-dashboard.html"
            : "user-dashboard.html";

        } catch (err) {
          console.error(err);
          errorBox.textContent = err.message || "Login failed. Please check your credentials.";
        } finally {
          loginBtn.disabled = false;
          loginBtn.style.opacity = "1";
        }
      });
    });
  </script>

</body>
</html>
